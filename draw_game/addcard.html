<!DOCTYPE html >
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0" />
    <title>H5添加卡券</title>
  </head>
  <style>
    #addCard{
      border: 1px solid;
      border-radius: 4px;
      margin-left: 20px;
      margin-right: 20px;
      margin-top: 30px;
      padding: 10px;
      text-align: center;
    }
  </style>
  <body>
    <div id="addCard">H5添加卡券</div>
  </body>
</html>
<script src="<?php echo Yii::app ()->theme->baseUrl; ?>/js/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
  var cardid;
  var nonce_str;
  var timestamp;
  var signature;
  $(function(){
    jssdkIndex();
    function jssdkIndex(){
      $.ajax({
        url:'http://wxjz.zjqq.mobi/data/h5card/index',
        data:{id:getPar(),url:window.location.href},
        type:'POST',
        dataType:'json',
        success:function(res){
          if(res.state == 'ok'){
            wx.config({
              debug: false,
              appId: res.data.signPackage.appId,
              timestamp: res.data.signPackage.timestamp,
              nonceStr: res.data.signPackage.nonceStr,
              signature: res.data.signPackage.signature,
              jsApiList: [
                'checkJsApi',
                'hideAllNonBaseMenuItem',
                'addCard'
              ]
            });
            cardid = res.data.signCard.cardId;
            nonce_str = res.data.signCard.nonce_str;
            timestamp = res.data.signCard.timestamp;
            signature = res.data.signCard.signature;
          } else {
            alert(res.msg)
          }
        }
      });
    }

  });
  //获取get参数id
  function getPar(){
    //获取当前URL
    var local_url = document.location.href;
    var get_par = local_url.lastIndexOf("#")>-1?local_url.substring(local_url.lastIndexOf("#")+1):"";
    return get_par;
  }

</script>
<script>
  wx.ready(function () {
    wx.hideAllNonBaseMenuItem({  //隐藏所有非基本菜单项
      success: function () {}
    });
  });
  wx.error(function (res) {
    alert(res.errMsg);
  });
  $(function(){
    $('#addCard').click(function(){
      wx.addCard({
        cardList: [
          {
            cardId: cardid,
            cardExt: '{"nonce_str":"'+nonce_str+'","timestamp":"'+timestamp+'","signature":"'+signature+'"}'
          }
        ],
        success: function (res) {
          alert('已添加卡券');
          //alert('已添加卡券：' + JSON.stringify(res.cardList));
        }
      });
    });
  });
</script>