function preload(){game.load.image("moon",imagesPath+"game_moon.png"),game.load.image("rectangle",imagesPath+"rectangle.png"),game.load.image("dash",imagesPath+"dash.png"),game.load.spritesheet("take_photo",imagesPath+"take_photo.png"),game.load.spritesheet("person_head",imagesPath+"person_head_big.png",275,422),game.load.spritesheet("person_all",imagesPath+"person.png",75,177)}function create(){game.stage.backgroundColor="#4B4387",mask_1=game.add.bitmapData(winWidth,winHeight),mask_1.context.fillStyle="#3F3678",mask_1.context.fillRect((winWidth-300)/2,toTop,300,196),mask_1.addToWorld(),group_dash_behind=game.add.group(),group_person_behind=game.add.group(),group_person_behind_move=game.add.group(),group_dash_front=game.add.group(),group_person_front=game.add.group(),group_person_front_move=game.add.group(),group_mask=game.add.group(),mask_2=game.add.bitmapData(winWidth,winHeight),mask_2.context.fillStyle="#4B4387",mask_2.context.fillRect((winWidth-300)/2-10,196+toTop,300,196),mask_2.addToWorld(),mask_3=game.add.bitmapData(winWidth,winHeight),mask_3.context.fillStyle="#4B4387",mask_3.context.fillRect(0,60,(winWidth-300)/2,392),mask_3.addToWorld(),shoot=game.add.button(winWidth/2,.8*winHeight,"take_photo",shoot,this),shoot.anchor.set(.5,0,5),shoot.scale.setTo(.5,.5);var a={font:"bold 14px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};text=game.add.text(0,0,"将人物拖动至上方照片内",a),text.setTextBounds(0,.64*winHeight,winWidth,100),group_move=game.add.group(),rectangle=game.add.sprite(winWidth/2,toTop,"rectangle"),rectangle.anchor.set(.5,0,5),group_mask.add(rectangle);for(var b=0;7>b;b++){var c=game.add.sprite(0,0,"dash");4>b?(c.position.x=(winWidth-240)/2+60*b,c.position.y=rectangle.height+rectangle.top-c.height,group_dash_front.add(c)):(c.position.x=(winWidth-180)/2+60*(b-4),c.position.y=rectangle.height+rectangle.top-c.height-50,group_dash_behind.add(c))}for(var b=0;7>b;b++)if(3>b){var d=game.add.sprite(0,0,"person_head",b);d.scale.set(.3,.3),d.position.x=(winWidth-300)/2+b*d.width+3*b*(100-d.width)/2,d.position.y=rectangle.height+rectangle.top-d.height-50+toRectangle,d.positionIndex=b,d.name=b,d.inputEnabled=!0,d.input.enableDrag(),d.events.onDragUpdate.add(dragUpdate,this),d.events.onDragStop.add(dropHandler,this),group_move.add(d)}else array.push(b)}function moveOut(a){if(time=null,console.log("move:"+time),0!=group_person_front.children.length||0!=group_person_behind.children.length){if(4>moveIndex){var b=parseInt(group_person_front.children[0].name),c=group_person_front.children[0].positionIndex,d=game.add.sprite(0,0,"person_all",b);d.position.x=(winWidth-240)/2+60*c-8,d.position.y=rectangle.height+rectangle.top-d.height+80-3,group_person_front_move.add(d);var e=game.add.tween(d).to({x:-75,alpha:.5},1e3,Phaser.Easing.Cubic.In,!0);e.onComplete.addOnce(function(){d.destroy(),array.push(b),count--,group_move.children.length<3&&dispose(null,array_move[0])},this),group_dash_front.children[c].alpha=1,group_person_front.children[0].destroy()}else{var b=parseInt(group_person_behind.children[0].name),c=group_person_behind.children[0].positionIndex,d=(group_person_behind.children[0],game.add.sprite(0,0,"person_all",b));d.position.x=(winWidth-180)/2+60*c-8,d.position.y=rectangle.height+rectangle.top-d.height-50+80-3,group_person_behind_move.add(d);var e=game.add.tween(d).to({x:-75,alpha:.5},1e3,Phaser.Easing.Cubic.In,!0);e.onComplete.addOnce(function(){d.destroy(),array.push(b),count--,group_move.children.length<3&&dispose(null,array_move[0])},this),group_dash_behind.children[c].alpha=1,group_person_behind.children[0].destroy()}moveIndex++,7==moveIndex&&(moveIndex=0)}}function judgeDrop(a){return 7==count?!1:a.y>50&&a.y<160&&a.x>(winWidth-300)/2-10&&a.x<winWidth-((winWidth-300)/2+60)+10?!0:!1}function dragUpdate(a){judgeDrop(a)?game.add.tween(a.scale).to({x:.225,y:.225},100,Phaser.Easing.Linear.In,!0):game.add.tween(a.scale).to({x:.3,y:.3},100,Phaser.Easing.Linear.Out,!0)}function dropHandler(a,b){var c=parseInt(a.name),d=a.positionIndex;if(judgeDrop(a)){if(7==index&&(index=0),4>index?group_dash_front.children[index].alpha=0:group_dash_behind.children[index-4].alpha=0,dispose(a,d),generate(c),null==time){var e=game.rnd.integerInRange(1,2);time=game.time.events.add(Phaser.Timer.SECOND*e,moveOut,this),console.log("r:"+e+" init:"+time)}}else a.scale.set(.3,.3),game.add.tween(a.position).to({x:(winWidth-300)/2+d*a.width+3*d*(100-a.width)/2,y:rectangle.height+rectangle.top-a.height-50+toRectangle},150,Phaser.Easing.Cubic.InOut,!0)}function dispose(a,b){a&&(a.destroy(),array_move.push(b));var c=parseInt(array_move[0]);if(!isNaN(array[0])){array_move.splice(0,1);var d=parseInt(array.splice(0,1)),e=game.add.sprite(0,0,"person_head",d);e.scale.set(.3,.3),e.positionIndex=b,e.name=d,e.position.x=(winWidth-300)/2+c*e.width+3*c*(100-e.width)/2,e.position.y=rectangle.height+rectangle.top-e.height-50+toRectangle,e.inputEnabled=!0,e.input.enableDrag(),e.events.onDragUpdate.add(dragUpdate,this),e.events.onDragStop.add(dropHandler,this),group_move.add(e)}}function generate(a){var b=game.add.sprite(0,0,"person_all",a);4>index?(b.position.x=(winWidth-240)/2+60*index-8,b.position.y=rectangle.height+rectangle.top-b.height+80-3,b.positionIndex=index,b.name=a,group_person_front.add(b)):(b.position.x=(winWidth-180)/2+60*(index-4)-8,b.position.y=rectangle.height+rectangle.top-b.height-50+80-3,b.positionIndex=index-4,b.name=a,group_person_behind.add(b)),count++,index++}function shoot(){var a=game.make.bitmapData(game.width,game.height),b=game.make.bitmapData(game.width,game.height);b.drawFull(game.world);var c=a.copy(b,(winWidth-300)/2,toTop,300,196,10,0,300,196);c.addToWorld()}function update(){}var winWidth=window.innerWidth,winHeight=window.innerHeight,game=new Phaser.Game(winWidth,winHeight,Phaser.CANVAS,"game",{preload:preload,create:create,update:update}),imagesPath="../images/",group_dash_behind,group_dash_front,group_person_behind,group_person_behind_move,group_person_front_move,group_person_front,group_move,group_mask,mask_1,mask_2,mask_3,index=0,count=0,array=[],array_move=[],rectangle,moveIndex=0,text,shoot,toTop=.1*winHeight.toFixed(0),toRectangle=.35*winHeight.toFixed(0),startFlag=!1,time;