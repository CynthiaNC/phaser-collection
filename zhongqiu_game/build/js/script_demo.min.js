function shootFlash(){white.style.display="none",white.setAttribute("class","abs white"),white.style.display="block",setTimeout(function(){white.setAttribute("class","abs white flash"),white.style.display="none"},100)}function preload(){game.load.image("rectangle",imagesPath+"rectangle.png"),game.load.image("dash",imagesPath+"dash.png"),game.load.spritesheet("take_photo",imagesPath+"take_photo.png"),game.load.spritesheet("person_head",imagesPath+"person_head.png",124,190),game.load.spritesheet("person_all",imagesPath+"person.png",150,354)}function create(){game.load.audio("kacha",imagesPath+"kacha.mp3"),game.stage.backgroundColor="#4B4387",mask_1=game.add.bitmapData(winWidth,winHeight),mask_1.context.fillStyle="#3F3678",mask_1.context.fillRect((winWidth-rectangleWidth)/2,toTop,rectangleWidth,rectangleHeight),mask_1.addToWorld(),group_dash_behind=game.add.group(),group_person_behind=game.add.group(),group_person_behind_move=game.add.group(),group_dash_front=game.add.group(),group_person_front=game.add.group(),group_person_front_move=game.add.group(),group_mask=game.add.group(),mask_2=game.add.bitmapData(winWidth,winHeight),mask_2.context.fillStyle="#4B4387",mask_2.context.fillRect((winWidth-rectangleWidth)/2,rectangleHeight+toTop,rectangleWidth,rectangleHeight),mask_2.addToWorld(),mask_3=game.add.bitmapData(winWidth,winHeight),mask_3.context.fillStyle="#4B4387",mask_3.context.fillRect(0,toTop,(winWidth-rectangleWidth)/2,2*rectangleHeight),mask_3.addToWorld(),mask_4=game.add.bitmapData(winWidth,winHeight),mask_4.context.fillStyle="#4B4387",mask_4.context.fillRect(winWidth-(winWidth-rectangleWidth)/2,toTop,(winWidth-rectangleWidth)/2,2*rectangleHeight),mask_4.addToWorld(),shoot=game.add.button(winWidth/2,.8*winHeight,"take_photo",shoot,this),shoot.anchor.set(.5,0,5);var a={font:"bold 28px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};text=game.add.text(0,0,"�������϶����Ϸ���Ƭ��",a),text.setTextBounds(0,.7*winHeight,winWidth,100),group_move=game.add.group(),rectangle=game.add.sprite(winWidth/2,toTop,"rectangle"),rectangle.anchor.set(.5,0,5),group_mask.add(rectangle);for(var b=0;7>b;b++){var c=game.add.sprite(0,0,"dash");4>b?(c.position.x=(winWidth-480)/2+120*b,c.position.y=rectangle.height+rectangle.top-c.height,group_dash_front.add(c)):(c.position.x=(winWidth-360)/2+120*(b-4),c.position.y=rectangle.height+rectangle.top-c.height-100,group_dash_behind.add(c))}for(var b=0;7>b;b++)if(3>b){var d=game.add.sprite(0,0,"person_head",b);d.position.x=(winWidth-480)/2+b*d.width+3*b*(160-d.width)/2,d.position.y=rectangle.height+rectangle.top-d.height-100+toRectangle,d.positionIndex=b,d.name=b,d.inputEnabled=!0,d.input.enableDrag(),d.events.onDragUpdate.add(dragUpdate,this),d.events.onDragStop.add(dropHandler,this),group_move.add(d)}else array.push(b);game.time.events.loop(1*Phaser.Timer.SECOND,moveOut,this)}function moveOut(a){var b=game.rnd.integerInRange(1,2);game.time.events.add(Phaser.Timer.SECOND*b,function(){if(0!=group_person_front.children.length||0!=group_person_behind.children.length){if(4>moveIndex){var a=parseInt(group_person_front.children[0].name);console.log("random:"+b+" name:"+a);var c=group_person_front.children[0].positionIndex,d=game.add.sprite(0,0,"person_all",a);d.position.x=(winWidth-496)/2+120*c-8,d.position.y=rectangle.height+rectangle.top-d.height+160-6,group_person_front_move.add(d);var e=1==game.rnd.integerInRange(1,2)?-75:winWidth+75,f=game.add.tween(d).to({x:e,alpha:.5},1e3,Phaser.Easing.Cubic.In,!0);f.onComplete.addOnce(function(){d.destroy(),array.push(a),count--,group_move.children.length<3&&dispose(null,array_move[0])},this),group_dash_front.children[c].alpha=1,group_person_front.children[0].destroy()}else{var a=parseInt(group_person_behind.children[0].name);console.log("random:"+b+" name:"+a);var c=group_person_behind.children[0].positionIndex,d=(group_person_behind.children[0],game.add.sprite(0,0,"person_all",a));d.position.x=(winWidth-372)/2+120*c-8,d.position.y=rectangle.height+rectangle.top-d.height-100+160-3,group_person_behind_move.add(d);var e=1==game.rnd.integerInRange(1,2)?-75:winWidth+75,f=game.add.tween(d).to({x:e,alpha:.5},1e3,Phaser.Easing.Cubic.In,!0);f.onComplete.addOnce(function(){d.destroy(),array.push(a),count--,group_move.children.length<3&&dispose(null,array_move[0])},this),group_dash_behind.children[c].alpha=1,group_person_behind.children[0].destroy()}moveIndex++,7==moveIndex&&(moveIndex=0)}},this)}function judgeDrop(a){return 7==count?!1:a.y>toTop&&a.y<rectangleHeight+toTop&&a.x>(winWidth-rectangleWidth)/2-10&&a.x<winWidth-((winWidth-rectangleWidth)/2+60)+10?!0:!1}function dragUpdate(a){judgeDrop(a)?game.add.tween(a.scale).to({x:.9,y:.9},100,Phaser.Easing.Linear.In,!0):game.add.tween(a.scale).to({x:1,y:1},100,Phaser.Easing.Linear.Out,!0)}function dropHandler(a,b){var c=parseInt(a.name),d=a.positionIndex;judgeDrop(a)?(7==index&&(index=0),4>index?group_dash_front.children[index].alpha=0:group_dash_behind.children[index-4].alpha=0,dispose(a,d),generate(c)):game.add.tween(a.position).to({x:(winWidth-480)/2+d*a.width+3*d*(160-a.width)/2,y:rectangle.height+rectangle.top-a.height-100+toRectangle},150,Phaser.Easing.Cubic.InOut,!0)}function dispose(a,b){a&&(a.destroy(),array_move.push(b));var c=parseInt(array_move[0]);if(!isNaN(array[0])){array_move.splice(0,1);var d=parseInt(array.splice(0,1)),e=game.add.sprite(0,0,"person_head",d);e.positionIndex=b,e.name=d,e.position.x=(winWidth-480)/2+c*e.width+3*c*(160-e.width)/2,e.position.y=rectangle.height+rectangle.top-e.height-100+toRectangle,e.inputEnabled=!0,e.input.enableDrag(),e.events.onDragUpdate.add(dragUpdate,this),e.events.onDragStop.add(dropHandler,this),group_move.add(e)}}function generate(a){var b=game.add.sprite(0,0,"person_all",a);4>index?(b.position.x=(winWidth-496)/2+124*index-8,b.position.y=rectangle.height+rectangle.top-b.height+160-6,b.positionIndex=index,b.name=a,group_person_front.add(b)):(b.position.x=(winWidth-372)/2+124*(index-4)-8,b.position.y=rectangle.height+rectangle.top-b.height-100+160-3,b.positionIndex=index-4,b.name=a,group_person_behind.add(b)),count++,index++}function shoot(){shootFlash();var a=game.make.bitmapData(game.width,game.height),b=game.make.bitmapData(game.width,game.height);b.drawFull(game.world);var c=a.copy(b,(winWidth-rectangleWidth)/2,toTop,rectangleWidth,rectangleHeight,10,0,rectangleWidth,rectangleHeight);c.addToWorld()}function update(){}var winWidth=window.innerWidth,winHeight=window.innerHeight,game=new Phaser.Game(winWidth,winHeight,Phaser.CANVAS,"game",{preload:preload,create:create,update:update}),imagesPath="../img/",group_dash_behind,group_dash_front,group_person_behind,group_person_behind_move,group_person_front_move,group_person_front,group_move,group_mask,mask_1,mask_2,mask_3,mask_4,index=0,count=0,array=[],array_move=[],rectangle,moveIndex=0,text,shoot,toTop=.06*winHeight.toFixed(0),toRectangle=.35*winHeight.toFixed(0),time,rectangleWidth=590,rectangleHeight=386,white=document.getElementById("white");